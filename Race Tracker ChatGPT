<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Race Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      display: flex;
      justify-content: space-between;
    }
    .stopwatch {
      flex: 1;
    }
    .timestamps {
      flex: 1;
      margin-left: 20px;
    }
    .timestamp-entry {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .timestamp-entry input {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Race Tracker</h1>
  <div class="container">
    <div class="stopwatch">
      <div id="display">00:00:00.000</div>
      <button id="startStopBtn">Start</button>
      <button id="resetBtn">Reset</button>
      <button id="saveBtn">Save Timestamp</button>
      <button id="downloadBtn">Download CSV</button>
    </div>
    <div class="timestamps">
      <h2>Timestamps</h2>
      <div id="timestampList"></div>
    </div>
  </div>

  <script>
    let isRunning = false;
    let startTime = 0;
    let elapsedTime = 0;
    let intervalId;
    const timestamps = [];

    const display = document.getElementById('display');
    const startStopBtn = document.getElementById('startStopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const timestampList = document.getElementById('timestampList');

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      const milliseconds = String(ms % 1000).padStart(3, '0');
      return `${hours}:${minutes}:${seconds}.${milliseconds}`;
    }

    function updateDisplay() {
      const now = Date.now();
      elapsedTime = now - startTime;
      display.textContent = formatTime(elapsedTime);
    }

    startStopBtn.addEventListener('click', () => {
      if (isRunning) {
        clearInterval(intervalId);
        elapsedTime += Date.now() - startTime;
        startStopBtn.textContent = 'Start';
      } else {
        startTime = Date.now() - elapsedTime;
        intervalId = setInterval(updateDisplay, 10); // Update every 10ms
        startStopBtn.textContent = 'Stop';
      }
      isRunning = !isRunning;
    });

    resetBtn.addEventListener('click', () => {
      clearInterval(intervalId);
      isRunning = false;
      startTime = 0;
      elapsedTime = 0;
      display.textContent = '00:00:00.000';
      startStopBtn.textContent = 'Start';
    });

    saveBtn.addEventListener('click', () => {
      const timestamp = formatTime(elapsedTime);
      const timestampEntry = document.createElement('div');
      timestampEntry.className = 'timestamp-entry';
      timestampEntry.innerHTML = `
        <span>${timestamp}</span>
        <input type="text" placeholder="Enter name">
      `;
      const input = timestampEntry.querySelector('input');
      timestamps.push({ timestamp, name: '' });

      input.addEventListener('input', (e) => {
        const index = Array.from(timestampList.children).indexOf(timestampEntry);
        timestamps[index].name = e.target.value;
      });

      timestampList.appendChild(timestampEntry);
    });

    downloadBtn.addEventListener('click', () => {
      const csvContent = 'data:text/csv;charset=utf-8,' + 
        'Timestamp,Name\n' + 
        timestamps.map(t => `${t.timestamp},${t.name}`).join('\n');
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'timestamps.csv');
      document.body.appendChild(link); // Required for Firefox
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
